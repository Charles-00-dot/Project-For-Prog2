import java.util.*;
import java.io.*;
import com.google.gson.*;
import com.google.gson.GsonBuilder;
import java.time.LocalDate;
import java.time.temporal.*;
import java.time.format.DateTimeParseException;
import com.google.gson.reflect.TypeToken;
import java.lang.reflect.Type;
public class Driver implements Payment {
	Scanner sc = new Scanner(System.in);
	static boolean exemExists(ArrayList<External_Member> exem, String id) {
		for(External_Member ex : exem) {
			if(ex.id_num.equalsIgnoreCase(id))
				return true;
		}
		return false;
	}
	
	static boolean studExists(ArrayList<Student> stud, String id) {
		for(Student s : stud) {
			if(s.id_num.equalsIgnoreCase(id))
				return true;
		}
		return false;
	}
	
	static boolean movExists(ArrayList<Movie> mov, String id) {
		for(Movie m : mov) {
			if(m.movie_id.equalsIgnoreCase(id))
				return true;
		}
		return false;
	}
	static boolean isAvailable(ArrayList<Rented> rt, String id) {
		
		for(Rented r : rt) {
			if(r.movie_id.equalsIgnoreCase(id))
				
				return true;
		}
		return false;
	}
	
	static boolean returnMovie(ArrayList<Rented> rt, ArrayList<Movie> mov, String id) {
		for(Rented r : rt) {
			for(Movie m: mov) {
				if(r.movie_id.equalsIgnoreCase(id) || m.movie_id.equalsIgnoreCase(id)) {
					rt.remove(r);
					return true;
				}
			}
		}
		return false;
	}
	
	
	public static void main(String[] args) {
		
		Gson gson = new GsonBuilder().setPrettyPrinting().create();
		String fps = "C:\\PROG2 PROJECT\\Student.json";
		String fpe = "C:\\PROG2 PROJECT\\External_Member.json";
		String fpm = "C:\\PROG2 PROJECT\\Movie.json";
		String fpr = "C:\\PROG2 PROJECT\\Rented.json";
		Payment pay = new Rental();
		
		ArrayList<Rented> rt = new ArrayList<>();
		
		ArrayList<External_Member> exem = new ArrayList<>();
		exem.add(new External_Member("Thomas", "th@example.com", "E1", "Doctor", "JD Hospital" ));
		exem.add(new External_Member("Neo", "n@example.com", "E2", "Mechanic", "JD Shop" ));
		exem.add(new External_Member("Joeffrey", "j@example.com", "E3", "Engineer", "JD Company" ));
		
		ArrayList<Student> stud = new ArrayList<>();
		stud.add(new Student("Charles", "ch@example.com", "S1", "A", "LP School" ));
		stud.add(new Student("Shaira", "sh@example.com", "S2", "B", "GG School" ));
		stud.add(new Student("Fritz", "f@example.com", "S3", "G", "KP School" ));
		
		
		ArrayList<Movie> mov = new ArrayList<>();
		mov.add(new Movie("Rise of the Guardians", "M1"));
		mov.add(new Movie("Iron Man", "M2"));
		mov.add(new Movie("10 Things I Hate About You", "M3"));
		
		Scanner sc = new Scanner(System.in);
		boolean f = true;
		while(f) {
		System.out.println("Menu: ");
		System.out.println("1 add student, 2  add external member, 3 add movie " ); 
		System.out.println("4 Show all students and info, 5 Show external member and info, 6 Show all movie and info " );
		System.out.println("7 Rent a movie, 8 Return a movie, 9 Exit ");
		
		int ans = sc.nextInt();		
		switch(ans) {
		case 1:
			File f1 = new File(fps);
			if(f1.exists() && f1.length() !=0) {
				try(FileReader fr = new FileReader(f1)){
					Type lts = new TypeToken<ArrayList<Student>>(){}.getType();
					stud = gson.fromJson(fr, lts);
				}catch (IOException e) {
					System.out.println("Error reading file: " + e.getMessage());
				}
			}
			System.out.println("All Students: ");
			for(Student s : stud) {
				System.out.println(s.getName() + " - " + s.getEmail() + " - " + s.getId_num() + ", " + s.getGrade() + ", " + s.getSl_name() );
			}
			
			while(true) {
				
				
				System.out.println("Enter student's ID number... ");
				String id_num = sc.next();
				
				if(studExists(stud, id_num)) {
					System.out.println("Duplicate value. Enter another id number. ");
				}else {
					System.out.println("Enter student's name... ");
					String name = sc.next();
					System.out.println("Enter student's email... ");
					String email = sc.next();
					System.out.println("Enter student's grade... ");
					String grade = sc.next();
					System.out.println("Enter student's school name... ");
					String sl_name= sc.next();
					stud.add(new Student(name, email, id_num, grade, sl_name));
					System.out.println("Student added. ");
					break;
				}
			}
			
				try(FileWriter fw1 = new FileWriter(fps)){
				gson.toJson(stud, fw1);
				System.out.println("Saved successfully. ");
				}
				catch (IOException e) {
					System.out.println("Error writing file: " + e.getMessage());
				}
				
			break;
		case 2:
			File f2 = new File(fpe);
			if(f2.exists() && f2.length() !=0) {
				try(FileReader fr2 = new FileReader(f2)){
					Type ltexem = new TypeToken<ArrayList<External_Member>>(){}.getType();
					exem = gson.fromJson(fr2, ltexem);
				}catch (IOException e) {
					System.out.println("Error reading file: " + e.getMessage());
				}
			}
			System.out.println("All External member: ");
			for(External_Member ex : exem) {
				System.out.println(ex.getName() + " - " + ex.getEmail() + " - " + ex.getId_num() + ", " + ex.getJob() + ", " + ex.getOrgani() );
			}
			while(true) {
				System.out.println("Enter external member's ID number... ");
				String idn1= sc.next();
				
				if(exemExists(exem, idn1)) {
					System.out.println("Duplicate value. Enter another id number. ");
				}else {
					System.out.println("Enter external member's name... ");
					String n1= sc.next();
					System.out.println("Enter external member's email... ");
					String em1 = sc.next();
					System.out.println("Enter external member's job... ");
					String job = sc.next();
					System.out.println("Enter external member's organization... ");
					String organi = sc.next();
					exem.add(new External_Member(n1, em1, idn1, job, organi));
					System.out.println("External member added. ");
					break;
				}
				
			}
			try(FileWriter fw2 = new FileWriter(fpe)){
				gson.toJson(exem, fw2);
				System.out.println("Saved successfully. ");
				}
				catch (IOException e) {
					System.out.println("Error writing file: " + e.getMessage());
				}
			
			break;
		case 3:
			File f3 = new File(fpm);
			if(f3.exists() && f3.length() !=0) {
				try(FileReader fr3 = new FileReader(f3)){
					Type ltm = new TypeToken<ArrayList<Movie>>(){}.getType();
					mov = gson.fromJson(fr3, ltm);
				}catch (IOException e) {
					System.out.println("Error reading file: " + e.getMessage());
				}
			}
			System.out.println("All Movies: ");
			for(Movie m : mov) {
				System.out.println(m.getMovie_name() + " - " + m.getMovie_id() );
			}
			while(true) {
				System.out.println("Enter movie's ID... ");
				String m_id = sc.next();
				
				if(movExists(mov, m_id)) {
					System.out.println("Duplicate value. Enter another id number. ");
				}else {
					System.out.println("Enter movie's name... ");
					String m_name = sc.next();
					mov.add(new Movie(m_name, m_id));
					System.out.println("Movie added. ");
					break;
				}
				
			}
			try(FileWriter fw3 = new FileWriter(fpm)){
				gson.toJson(mov, fw3);
				System.out.println("Saved successfully. ");
				}
				catch (IOException e) {
					System.out.println("Error writing file: " + e.getMessage());
				}
			
			break;
		case 4:
			File f4 = new File(fps);
			if(f4.exists() && f4.length() !=0) {
				try(FileReader fr4 = new FileReader(f4)){
					Type lts = new TypeToken<ArrayList<Student>>(){}.getType();
					stud = gson.fromJson(fr4, lts);
				}catch (IOException e) {
					System.out.println("Error reading file: " + e.getMessage());
				}
			}
			System.out.println("All Students: ");
			for(Student s : stud) {
				System.out.println(s.getName() + " - " + s.getEmail() + " - " + s.getId_num() + ", " + s.getGrade() + ", " + s.getSl_name() );
			}
			
			break;
		case 5:
			File f5 = new File(fpe);
			if(f5.exists() && f5.length() !=0) {
				try(FileReader fr5 = new FileReader(f5)){
					Type ltexem = new TypeToken<ArrayList<External_Member>>(){}.getType();
					exem = gson.fromJson(fr5, ltexem);
				}catch (IOException e) {
					System.out.println("Error reading file: " + e.getMessage());
				}
			}
			System.out.println("All External member: ");
			for(External_Member ex : exem) {
				System.out.println(ex.getName() + " - " + ex.getEmail() + " - " + ex.getId_num() + ", " + ex.getJob() + ", " + ex.getOrgani() );
			}
			break;
		case 6:

			File f6 = new File(fpm);
			if(f6.exists() && f6.length() !=0) {
				try(FileReader fr6 = new FileReader(f6)){
					Type ltm = new TypeToken<ArrayList<Movie>>(){}.getType();
					mov = gson.fromJson(fr6, ltm);
				}catch (IOException e) {
					System.out.println("Error reading file: " + e.getMessage());
				}
			}
			System.out.println("All Movies: ");
			for(Movie m : mov) {
				System.out.println(m.getMovie_name() + " - " + m.getMovie_id() );
			}
			
		
			File f7 = new File(fpr);
			if(f7.exists() && f7.length() !=0) {
				try(FileReader fr4 = new FileReader(f7)){
					Type ltr = new TypeToken<ArrayList<Rented>>(){}.getType();
					rt = gson.fromJson(fr4, ltr);
				}catch (IOException e) {
					System.out.println("Error reading file: " + e.getMessage());
				}
			}
			System.out.println("All Rented Movies: ");
			for(Rented r : rt) {
				System.out.println("Member ID: " + r.getMember_id() + " - Movie ID: " + r.getMovie_id() );
			}
			break;
		case 7:
			
			try {
			String d1_s, d2_s, rent_ids = null, rent_idm = null;
			
			System.out.println("Do you wish to rent a movie? ");
			String ch = sc.next();
			if(ch.equalsIgnoreCase("Yes")) {
				System.out.println("For how long do you wish to rent? ");
				System.out.println("Enter the rent day (YYYY-MM-DD format):... ");
				d1_s = sc.next();
				System.out.println("Enter the return day (YYYY-MM-DD format):... ");
				d2_s = sc.next();
				LocalDate d1l = LocalDate.parse(d1_s);
				LocalDate d2l = LocalDate.parse(d2_s);
				System.out.println("Successfully entered dates: " + d1l + " - " + d2l);
				if(pay instanceof Rental) {
					Rental r = (Rental) pay;
					r.nights_rented(d1l, d2l);
					long diff_days =ChronoUnit.DAYS.between(d1l, d2l);
					int diff_int = (int) diff_days;
					System.out.println("Are you a student or external member? ");
					String type = sc.next();
					if(type.equalsIgnoreCase("Student")) {
						System.out.println("Enter your ID number... ");
						String ids = sc.next();
						for (Student s : stud) {
						    
						    if (s.getId_num().equalsIgnoreCase(ids)) {
						        rent_ids = s.getId_num(); 
						        break; 
						    }
						}
						try {
						System.out.println("Enter the movie ID you wish to rent... ");
						String idm = sc.next();
						for (Movie m : mov) {
						    
						    if (m.getMovie_id().equalsIgnoreCase(idm)) {
						        rent_idm = m.getMovie_id(); 
						        break; 
						    }
						}
						}catch(Exception e) {
							System.out.println("An error occurred while entering movie ID: " + e.getMessage());
						}
						if(rent_ids != null && rent_idm != null) {
							if(!isAvailable(rt, rent_idm)) {
								rt.add(new Rented(rent_ids, rent_idm));
							   
							    System.out.println("Rent recorded successfully.");
							}
							if (rent_ids == null)
								System.out.println("Error: Student ID not found. ");
							if (rent_idm == null)
								System.out.println("Error: Movie ID not found. ");
							    
							}
						
						
						try(FileWriter fwr1 = new FileWriter(fpr)){
							if(pay instanceof Rental) {
								if(rent_ids != null && rent_idm != null) {
									Rental.calStud(diff_int);
								} else {
									System.out.println( "The external member's fee: $" + fee_students);
								}
								
							}
							gson.toJson(rt, fwr1);
							System.out.println("Saved successfully. ");
							}
							catch (IOException e) {
								System.out.println("Error writing file: " + e.getMessage());
							}
							
						break;
						
					}
					if(type.equalsIgnoreCase("External Member")) {
						System.out.println("Enter your ID number... ");
						String ide = sc.next();
						for (External_Member ex : exem) {
						    
						    if (ex.getId_num().equalsIgnoreCase(ide)) {
						        rent_ids = ex.getId_num(); 
						        break; 
						    }
						}
						System.out.println("Enter the movie ID you wish to rent... ");
						String idm = sc.next();
						for (Movie m : mov) {
						    
						    if (m.getMovie_id().equalsIgnoreCase(idm)) {
						        rent_idm = m.getMovie_id(); 
						        break; 
						    }
						}
						if(rent_ids != null && rent_idm != null) {
							if(!isAvailable(rt, rent_idm)) {
								rt.add(new Rented(rent_ids, rent_idm));
							
							    System.out.println("Rent recorded successfully.");
							}
								if (rent_ids == null)
									System.out.println("Error: External Member ID not found.");
							    if (rent_idm == null)
									System.out.println("Error: Movie ID not found.");
							}
							
						
						if(pay instanceof Rental) {
							if(rent_ids != null && rent_idm != null) {
								Rental.calExem(diff_int);
							} else {
								System.out.println( "The external member's fee: $" + fee_Ex_member);
							}
							
						}
						try(FileWriter fwr2 = new FileWriter(fpr)){
							gson.toJson(rt, fwr2);
							System.out.println("Saved successfully. ");
							}
							catch (IOException e) {
								System.out.println("Error writing file: " + e.getMessage());
							}
							
						break;
					}else {
							System.out.println("Invalid type. Please enter either 'Student' or 'External Member'. ");
				}
			}
				
				
		}
			
		}catch (DateTimeParseException e) {
	            
	            System.err.println("Error: Invalid date format. Please use YYYY-MM-DD."); 
	        }
			
			break;
		case 8:
			File f8 = new File(fpr);
			if(f8.exists() && f8.length() !=0) {
				try(FileReader fr8 = new FileReader(f8)){
					Type ltr = new TypeToken<ArrayList<Rented>>(){}.getType();
					rt = gson.fromJson(fr8, ltr);
				}catch (IOException e) {
					System.out.println("Error reading file: " + e.getMessage());
				}
			}
			System.out.println("All Rented Movies: ");
			for(Rented r : rt) {
				System.out.println("Member ID: " + r.getMember_id() + " - Movie ID: " + r.getMovie_id() );
			}
		
			try {
			System.out.println("Enter the movie ID you wish to return... ");
			String return_id = sc.next();
			if(returnMovie(rt, mov, return_id)) {
				System.out.println("Movie returned successfully. ");
			}
			}catch (Exception e) {
				System.out.println("An error occurred while returning the movie: " + e.getMessage());
			}
			try(FileWriter fwr3 = new FileWriter(fpr)){
				gson.toJson(rt, fwr3);
				System.out.println("Saved successfully. ");
				}
				catch (IOException e) {
					System.out.println("Error writing file: " + e.getMessage());
				}
		break;
		case 9:
			System.out.println("EXITED");
			f = false;
			break;
			
		}
		}
		
	

	}

}
